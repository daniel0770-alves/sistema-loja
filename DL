<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DL Desenvolvimento - Gestão Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #1e293b; overflow-x: hidden; }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01); }
        .tab-active { background-color: #1e293b; color: #3b82f6; border-bottom: 4px solid #3b82f6; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        input, select, textarea { transition: all 0.2s; border: 1px solid #cbd5e1; border-radius: 12px; }
        input:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15); }
        .os-card:hover { transform: translateY(-3px); transition: transform 0.2s ease; }
    </style>
</head>
<body class="min-h-screen">

    <header class="bg-slate-900 text-white shadow-2xl sticky top-0 z-50">
        <div class="container mx-auto p-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-5">
                <div class="w-14 h-14 bg-white rounded-2xl flex items-center justify-center p-1 shadow-inner border-2 border-blue-500">
                    <span class="text-slate-900 font-black text-xl italic">DL</span>
                </div>
                <div>
                    <h1 class="text-lg font-black tracking-tight leading-none uppercase italic">DL DESENVOLVIMENTO</h1>
                    <span class="text-[9px] text-blue-400 font-bold uppercase tracking-[0.3em]">Gestão de Fluxo Gráfico</span>
                </div>
            </div>

            <nav class="flex bg-slate-800 p-1 rounded-2xl">
                <button id="btn-cadastro" onclick="switchTab('cadastro')" class="px-5 py-2.5 rounded-xl text-[9px] font-black uppercase transition-all tab-active">
                    <i class="fas fa-plus-circle mr-2"></i>Nova OS
                </button>
                <button id="btn-prazos" onclick="switchTab('prazos')" class="px-5 py-2.5 rounded-xl text-[9px] font-black uppercase transition-all text-slate-400 hover:text-white">
                    <i class="fas fa-chart-line mr-2"></i>Painel de Controle
                </button>
            </nav>
        </div>
    </header>

    <main class="container mx-auto p-4 lg:p-8">
        
        <!-- ABA: CADASTRO -->
        <div id="tab-cadastro" class="tab-content animate-fade-in">
            <div class="max-w-5xl mx-auto bg-white rounded-[2.5rem] card-shadow border border-slate-200 overflow-hidden">
                <div class="bg-slate-50 border-b p-6 flex justify-between items-center">
                    <h2 class="text-[10px] font-black text-slate-800 uppercase tracking-[0.2em] flex items-center">
                        <span class="w-2 h-2 bg-blue-500 rounded-full mr-3"></span>Novo Registro de Serviço
                    </h2>
                    <div class="flex items-center gap-2">
                        <span class="text-[9px] font-bold text-slate-400 uppercase">ID Protocolo:</span>
                        <input type="text" id="caixacodigo" readonly class="w-28 bg-white border-slate-200 rounded-lg text-center font-black text-[10px] p-1.5 text-blue-600">
                    </div>
                </div>

                <div class="p-6 lg:p-10 grid grid-cols-1 md:grid-cols-3 gap-10">
                    <div class="space-y-5">
                        <h3 class="text-[10px] font-black text-blue-600 uppercase tracking-widest border-b pb-2">Informações do Cliente</h3>
                        <div>
                            <label class="text-[9px] font-black text-slate-400 uppercase mb-1.5 block">Nome do Cliente</label>
                            <input type="text" id="campoCliente" placeholder="Nome completo" class="w-full p-3.5 bg-slate-50 font-bold text-sm">
                        </div>
                        <div>
                            <label class="text-[9px] font-black text-slate-400 uppercase mb-1.5 block">WhatsApp</label>
                            <input type="text" id="campoContato" placeholder="(00) 00000-0000" class="w-full p-3.5 bg-slate-50 font-mono text-xs">
                        </div>
                        <div>
                            <label class="text-[9px] font-black text-slate-400 uppercase mb-1.5 block">Descrição do Trabalho</label>
                            <textarea id="caixaserviço" rows="4" placeholder="Detalhes do pedido..." class="w-full p-3.5 bg-slate-50 font-medium text-sm"></textarea>
                        </div>
                    </div>

                    <div class="space-y-5">
                        <h3 class="text-[10px] font-black text-green-600 uppercase tracking-widest border-b pb-2">Financeiro</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[9px] font-black text-slate-400 uppercase mb-1.5 block">Total R$</label>
                                <input type="number" id="caixavalortotal" oninput="calcSaldo()" placeholder="0.00" class="w-full p-3.5 bg-blue-50 text-blue-700 font-black text-lg">
                            </div>
                            <div>
                                <label class="text-[9px] font-black text-slate-400 uppercase mb-1.5 block">Entrada R$</label>
                                <input type="number" id="caixadepositado" oninput="calcSaldo()" placeholder="0.00" class="w-full p-3.5 bg-green-50 text-green-700 font-black text-lg">
                            </div>
                        </div>
                        <div class="bg-slate-900 p-6 rounded-[2rem] text-center shadow-xl border-4 border-slate-800">
                            <span class="text-[9px] font-black text-blue-400 uppercase block mb-1">Saldo a Receber</span>
                            <div id="displaySaldo" class="text-3xl font-black text-white italic">R$ 0,00</div>
                        </div>
                    </div>

                    <div class="space-y-5">
                        <h3 class="text-[10px] font-black text-orange-600 uppercase tracking-widest border-b pb-2">Logística</h3>
                        <div>
                            <label class="text-[9px] font-black text-slate-400 uppercase mb-1.5 block">Previsão</label>
                            <input type="date" id="caixadatafinal" class="w-full p-3.5 bg-slate-50 font-bold text-xs">
                        </div>
                        <div>
                            <label class="text-[9px] font-black text-slate-400 uppercase mb-1.5 block">Status</label>
                            <select id="caixastatus" class="w-full p-3.5 bg-slate-50 font-black text-[10px] uppercase">
                                <option>Aguardando Arquivo</option>
                                <option>Em Criação / Arte</option>
                                <option>Em Produção</option>
                                <option>Pronto / Retirada</option>
                                <option>Finalizado</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-50 p-8 flex justify-center border-t border-slate-200">
                    <button id="btnSalvar" onclick="salvarOS()" class="px-20 py-5 bg-blue-600 text-white rounded-[1.5rem] font-black text-[11px] uppercase shadow-2xl hover:bg-blue-700 active:scale-95 transition-all flex items-center gap-4">
                        <i class="fas fa-cloud-upload-alt text-lg"></i> Salvar Ordem de Serviço
                    </button>
                </div>
            </div>
        </div>

        <!-- ABA: PAINEL DE CONTROLE -->
        <div id="tab-prazos" class="tab-content hidden animate-fade-in">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-black text-slate-800 italic uppercase">Fluxo de Trabalho</h2>
                <input type="text" id="buscaCliente" oninput="filtrarCards()" placeholder="Procurar cliente..." class="px-6 py-3 bg-white rounded-2xl border-none shadow-sm font-bold text-xs w-64">
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 text-center">
                <div class="bg-white p-4 rounded-3xl card-shadow border border-slate-100">
                    <span class="text-[8px] font-black text-slate-400 uppercase">Ordens Ativas</span>
                    <div id="countTotal" class="text-xl font-black text-slate-800">0</div>
                </div>
                <div class="bg-white p-4 rounded-3xl card-shadow border border-slate-100">
                    <span class="text-[8px] font-black text-red-400 uppercase">Pendente Total</span>
                    <div id="countPendente" class="text-lg font-black text-red-500">R$ 0,00</div>
                </div>
                <div class="bg-white p-4 rounded-3xl card-shadow border border-slate-100">
                    <span class="text-[8px] font-black text-green-400 uppercase">Pronto</span>
                    <div id="countPronto" class="text-xl font-black text-green-600">0</div>
                </div>
                <div class="bg-white p-4 rounded-3xl card-shadow border border-slate-100">
                    <span class="text-[8px] font-black text-blue-400 uppercase">Total Geral</span>
                    <div id="countHoje" class="text-xl font-black text-blue-600">0</div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="gridOS">
                <!-- Cards automáticos -->
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // CONFIGURAÇÃO DO SEU FIREBASE INSERIDA:
        const firebaseConfig = {
            apiKey: "AIzaSyCToRRCqtuNdw-z5L9ZL6DMstjy4kkVwAg",
            authDomain: "dl-grafica.firebaseapp.com",
            projectId: "dl-grafica",
            storageBucket: "dl-grafica.firebasestorage.app",
            messagingSenderId: "857701364480",
            appId: "1:857701364480:web:0e8d2b1f6f2ae39501b9e5",
            measurementId: "G-X2P8XR5WFT"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Identificador único para os seus dados
        const appId = "dl-grafica-app";

        // Protocolo Aleatório
        document.getElementById('caixacodigo').value = "DL" + Math.floor(1000 + Math.random() * 9000);

        // Autenticação anônima obrigatória para o Firestore funcionar
        signInAnonymously(auth).catch((err) => {
            console.error("Erro Auth:", err);
            alert("Erro de conexão com o banco de dados.");
        });

        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab-' + tab).classList.remove('hidden');
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('tab-active'));
            document.getElementById('btn-' + tab).classList.add('tab-active');
        };

        window.calcSaldo = () => {
            const total = parseFloat(document.getElementById('caixavalortotal').value) || 0;
            const dep = parseFloat(document.getElementById('caixadepositado').value) || 0;
            document.getElementById('displaySaldo').innerText = "R$ " + (total - dep).toLocaleString('pt-BR', {minimumFractionDigits: 2});
        };

        window.salvarOS = async () => {
            const cliente = document.getElementById('campoCliente').value;
            if(!cliente) return alert("Por favor, digite o nome do cliente.");

            const btn = document.getElementById('btnSalvar');
            btn.disabled = true;
            btn.innerText = 'Salvando no Banco...';

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'os_registros'), {
                    codigo: document.getElementById('caixacodigo').value,
                    cliente: cliente,
                    contato: document.getElementById('campoContato').value,
                    servico: document.getElementById('caixaserviço').value,
                    total: parseFloat(document.getElementById('caixavalortotal').value) || 0,
                    depositado: parseFloat(document.getElementById('caixadepositado').value) || 0,
                    status: document.getElementById('caixastatus').value,
                    prazo: document.getElementById('caixadatafinal').value,
                    timestamp: serverTimestamp()
                });
                alert("Ordem de Serviço salva com sucesso!");
                location.reload();
            } catch (err) {
                console.error("Erro Firestore:", err);
                alert("Erro ao salvar! Verifique se ativou o Firestore e as Regras (read/write: if true).");
                btn.disabled = false;
                btn.innerText = 'Salvar Ordem de Serviço';
            }
        };

        window.excluirOS = async (id) => {
            if(confirm("Tem certeza que deseja excluir permanentemente?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'os_registros', id));
            }
        };

        window.filtrarCards = () => {
            const busca = document.getElementById('buscaCliente').value.toLowerCase();
            document.querySelectorAll('.os-card').forEach(card => {
                const nome = card.getAttribute('data-cliente').toLowerCase();
                card.style.display = nome.includes(busca) ? 'block' : 'none';
            });
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'os_registros'), orderBy("timestamp", "desc"));
                onSnapshot(q, (snapshot) => {
                    const grid = document.getElementById('gridOS');
                    grid.innerHTML = "";
                    let penTotal = 0; 
                    let prontoCount = 0;

                    if(snapshot.empty) {
                        grid.innerHTML = '<div class="col-span-full text-center py-20 text-slate-300 font-bold uppercase text-[10px] tracking-widest italic">Aguardando novos registros...</div>';
                    }

                    snapshot.forEach(docSnap => {
                        const os = docSnap.data();
                        const pendente = (os.total - os.depositado);
                        penTotal += pendente;
                        if(os.status === 'Pronto / Retirada') prontoCount++;

                        const corStatus = os.status === 'Pronto / Retirada' ? 'bg-green-100 text-green-600' : (os.status === 'Finalizado' ? 'bg-slate-100 text-slate-400' : 'bg-blue-100 text-blue-600');
                        
                        grid.innerHTML += `
                            <div class="bg-white p-6 rounded-[2.5rem] card-shadow border border-slate-100 relative os-card animate-fade-in" data-cliente="${os.cliente}">
                                <button onclick="excluirOS('${docSnap.id}')" class="absolute top-5 right-5 text-slate-200 hover:text-red-500 transition-all">
                                    <i class="fas fa-trash-alt text-xs"></i>
                                </button>
                                <div class="flex justify-between items-center mb-4">
                                    <span class="text-[8px] font-black text-slate-300 tracking-tighter">ID #${os.codigo}</span>
                                    <span class="px-3 py-1 ${corStatus} rounded-full text-[8px] font-black uppercase">${os.status}</span>
                                </div>
                                <h4 class="font-black text-slate-800 uppercase text-[11px] mb-1 truncate">${os.cliente}</h4>
                                <p class="text-[10px] text-slate-400 mb-5 line-clamp-2 h-8 leading-tight">${os.servico || 'Sem descrição'}</p>
                                <div class="bg-slate-50 rounded-[1.5rem] p-4 flex justify-between items-center border border-slate-100">
                                    <div>
                                        <span class="text-[7px] font-black text-slate-400 uppercase block">Falta Pagar</span>
                                        <span class="text-xs font-black ${pendente > 0 ? 'text-red-500' : 'text-green-500'} italic">R$ ${pendente.toFixed(2)}</span>
                                    </div>
                                    <div class="text-right">
                                        <span class="text-[7px] font-black text-slate-400 uppercase block">Entrega</span>
                                        <span class="text-[9px] font-black text-slate-700">${os.prazo ? os.prazo.split('-').reverse().join('/') : '--/--'}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    document.getElementById('countTotal').innerText = snapshot.size;
                    document.getElementById('countPronto').innerText = prontoCount;
                    document.getElementById('countPendente').innerText = "R$ " + penTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                    document.getElementById('countHoje').innerText = snapshot.size;
                });
            }
        });
    </script>
</body>
</html>
